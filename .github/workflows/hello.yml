name: CI ‚ûú Deploy Node22 to Target

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [ self-hosted, Linux, X64 ]

    steps:
      - uses: actions/checkout@v4

      - name: Copy index.js to Target VM
        uses: appleboy/scp-action@v1
        with:
          host:     ${{ secrets.TARGET_HOST }}    # e.g. "target"
          username: ${{ secrets.TARGET_USER }}    # e.g. "laborant"
          key:      ${{ secrets.TARGET_SSH_KEY }}  # your Jenkins‚ÜíTarget private key
          port:     22
          source:   "index.js"
          target:   "~/deploy/"

      # SSH into target, unpack, move into /opt/myapp, restart systemd
      - uses: appleboy/ssh-action@v1
        with:
          host:     ${{ secrets.TARGET_HOST }}
          username: ${{ secrets.TARGET_USER }}
          key:      ${{ secrets.TARGET_SSH_KEY }}
          port:     22
          script: |
            set -eux
            mkdir -p ~/deploy
            cd ~/deploy
            
            #make a folder
            sudo mkdir -p /opt/myapp
            sudo rm -rf /opt/myapp/*
            sudo mv index.js /opt/myapp/
            sudo chown -R ${{ secrets.TARGET_USER }}: /opt/myapp

            echo "üòÅ"

            # Create a systemd process
            sudo tee /etc/systemd/system/myapp.service << 'EOF'
            [Unit]
            Description=My Node22 App
            After=network.target

            [Service]
            Type=simple
            User=${{ secrets.TARGET_USER }}
            WorkingDirectory=/opt/myapp
            ExecStart=/usr/bin/node /opt/myapp/index.js
            Restart=always
            Environment=NODE_ENV=production

            [Install]
            WantedBy=multi-user.target
            EOF

            #reload and keept it alive
            sudo systemctl daemon-reload
            sudo systemctl enable myapp.service
            sudo systemctl restart myapp.service
