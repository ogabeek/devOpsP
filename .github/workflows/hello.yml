# .github/workflows/hello.yml
name: CI âœ Deploy Node22 to Target

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [ self-hosted, Linux, X64 ]

    steps:
      - uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2ï¸âƒ£  Install Node 22 & run unit tests (including index.test.js)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Node 22 and run tests
        uses: actions/setup-node@v3
        with:
          node-version: "22.x"
      - name: Install dependencies & run tests
        run: |
          npm install              # installs express (and any other dep) based on package.json
          node --test              # runs index.test.js (your unit test)
        working-directory: ${{ github.workspace }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3ï¸âƒ£  Copy index.js, package.json, and package-lock.json to Target
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Copy application files to Target VM
        uses: appleboy/scp-action@v1
        with:
          host:     ${{ secrets.TARGET_HOST }}    # e.g. "target"
          username: ${{ secrets.TARGET_USER }}    # e.g. "laborant"
          key:      ${{ secrets.TARGET_SSH_KEY }}  # Jenkinsâ†’Target private key
          port:     22
          source:   "index.js,package.json,package-lock.json"
          target:   "~/deploy/"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4ï¸âƒ£  SSH into target:
      #      â€¢ Install production dependencies (Express)
      #      â€¢ Move all files into /opt/myapp
      #      â€¢ Create/overwrite systemd unit
      #      â€¢ Reload & restart service
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy & start on Target VM
        uses: appleboy/ssh-action@v1
        with:
          host:     ${{ secrets.TARGET_HOST }}
          username: ${{ secrets.TARGET_USER }}
          key:      ${{ secrets.TARGET_SSH_KEY }}
          port:     22
          script: |
            set -eux
            mkdir -p ~/deploy
            cd ~/deploy
            
            # Install productionâ€only dependencies on Target (uses package.json & lock file)
            npm install --production

            #make a folder
            sudo mkdir -p /opt/myapp
            sudo rm -rf /opt/myapp/*
            sudo mv * /opt/myapp/
            sudo chown -R ${{ secrets.TARGET_USER }}: /opt/myapp

            echo "ğŸ˜"

            # Create or overwrite the systemd service
            sudo tee /etc/systemd/system/myapp.service << 'EOF'
            [Unit]
            Description=My Node22 Express App
            After=network.target

            [Service]
            Type=simple
            User=${{ secrets.TARGET_USER }}
            WorkingDirectory=/opt/myapp
            ExecStart=/usr/bin/node /opt/myapp/index.js
            Restart=always
            Environment=NODE_ENV=production

            [Install]
            WantedBy=multi-user.target
            EOF

            #reload and keep it alive
            sudo systemctl daemon-reload
            sudo systemctl enable myapp.service
            sudo systemctl restart myapp.service
